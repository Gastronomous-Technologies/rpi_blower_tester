SCRIPT_DIR=INSTALL_DIR

unset DOCKER_HOST
docker context use rootless

. $SCRIPT_DIR/src/*.env

chvt 12 #as in service file

for cmd in "$@"

do

  case $cmd in 

    -b|--build)
      echo "Building/Rebuilding "$BLOWER_APP_NAME" Version: "$BLOWER_APP_VERSION
      docker build -t $BLOWER_APP_NAME $SCRIPT_DIR/src/$BLOWER_PY_APP/
    ;;

    -h|--help)
      man $SCRIPT_DIR/../man/man1/$BLOWER_EXEC_FILE.1
      ;;

    -r|--run)
      echo "Running "$BLOWER_APP_NAME

      GPIO_GID=$(getent group gpio | cut -d: -f3)
      DIALOUT_GID=$(getent group dialout | cut -d: -f3)

      docker run --device=/dev/gpiomem --device=/dev/gpiochip0 \
                 --device=$(ls /dev/stlinkv2*) --device=/dev/spidev0.0 \
                 -v /sys/bus/i2c:/sys/bus/i2c --rm -it $BLOWER_APP_NAME
    ;;

    -t|--test)
      echo "Testing "$BLOWER_APP_NAME
      docker run --rm $BLOWER_APP_NAME python -m pytest -o cache_dir=$WORKSPACE
     ;;

   -*|--*)
      printf "Unknown command: "$1"\n"
      printf "Perhaps see man page or run "$BLOWER_APP_NAME "--help"
      printf "\nSkipping ...\n"
    ;;

  esac

done
